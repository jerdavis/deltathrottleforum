<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>The Delta Throttle &bull; View topic - Compiler Issues</title>

<link rel="alternate" type="application/atom+xml" title="Feed - The Delta Throttle" href="http://deltathrottle.com/forums/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://deltathrottle.com/forums/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - Build progress and showcase" href="http://deltathrottle.com/forums/feed.php?f=8" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Compiler Issues" href="http://deltathrottle.com/forums/feed.php?f=8&amp;t=118" />

<!--
	phpBB style name: prosilver
	Based on style:   prosilver (this is the default phpBB3 style)
	Original author:  Tom Beddard ( http://www.subBlue.com/ )
	Modified by:
-->

<script type="text/javascript">
// <![CDATA[
	var jump_page = 'Enter the page number you wish to go to:';
	var on_page = '1';
	var per_page = '10';
	var base_url = './viewtopic.php?f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e';
	var style_cookie = 'phpBBstyle';
	var style_cookie_settings = '; path=/; domain=.deltathrottle.com';
	var onload_functions = new Array();
	var onunload_functions = new Array();

	

	/**
	* Find a member
	*/
	function find_username(url)
	{
		popup(url, 760, 570, '_usersearch');
		return false;
	}

	/**
	* New function for handling multiple calls to window.onload and window.unload by pentapenguin
	*/
	window.onload = function()
	{
		for (var i = 0; i < onload_functions.length; i++)
		{
			eval(onload_functions[i]);
		}
	};

	window.onunload = function()
	{
		for (var i = 0; i < onunload_functions.length; i++)
		{
			eval(onunload_functions[i]);
		}
	};

// ]]>
</script>
<script type="text/javascript" src="styles/prosilver/template/styleswitcher.js"></script>
<script type="text/javascript" src="styles/prosilver/template/forum_fn.js"></script>

<link href="styles/prosilver/theme/print.css" rel="stylesheet" type="text/css" media="print" title="printonly" />
<link href="style.php@id=1&amp;lang=en&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.css" rel="stylesheet" type="text/css" media="screen, projection" />

<link href="styles/prosilver/theme/normal.css" rel="stylesheet" type="text/css" title="A" />
<link href="styles/prosilver/theme/medium.css" rel="alternate stylesheet" type="text/css" title="A+" />
<link href="styles/prosilver/theme/large.css" rel="alternate stylesheet" type="text/css" title="A++" />



</head>

<body id="phpbb" class="section-viewtopic ltr">

<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>
	<div id="page-header">
		<div class="headerbar">
			<div class="inner"><span class="corners-top"><span></span></span>

			<div id="site-description">
				<a href="index.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Board index" id="logo"></a>
				<h1>The Delta Throttle</h1>
				<p></p>
				<p class="skiplink"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#start_here">Skip to content</a></p>
			</div>

		
			<div id="search-box">
				<form action="search.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html" method="get" id="search">
				<fieldset>
					<input name="keywords" id="keywords" type="text" maxlength="128" title="Search for keywords" class="inputbox search" value="Search…" onclick="if(this.value=='Search…')this.value='';" onblur="if(this.value=='')this.value='Search…';" />
					<input class="button2" value="Search" type="submit" /><br />
					<a href="search.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="View the advanced search options">Advanced search</a> <input type="hidden" name="sid" value="2da7d3261aa1b35db93cfc0fa069564e" />

				</fieldset>
				</form>
			</div>
		

			<span class="corners-bottom"><span></span></span></div>
		</div>

		<div class="navbar">
			<div class="inner"><span class="corners-top"><span></span></span>

			<ul class="linklist navlinks">
				<li class="icon-home"><a href="index.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html" accesskey="h">Board index</a>  <strong>&#8249;</strong> <a href="viewforum.php@f=1&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Delta Throttle</a> <strong>&#8249;</strong> <a href="viewforum.php@f=8&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Build progress and showcase</a></li>

				<li class="rightside"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="fontsizeup(); return false;" onkeypress="return fontsizeup(event);" class="fontsize" title="Change font size">Change font size</a></li>

				<li class="rightside"><a href="viewtopic.php@f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e&amp;view=print.html" title="Print view" accesskey="p" class="print">Print view</a></li>
			</ul>

			

			<ul class="linklist rightside">
				<li class="icon-faq"><a href="faq.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Frequently Asked Questions">FAQ</a></li>
				<li class="icon-register"><a href="ucp.php@mode=register&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Register</a></li>
					<li class="icon-logout"><a href="ucp.php@mode=login&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Login" accesskey="x">Login</a></li>
				
			</ul>

			<span class="corners-bottom"><span></span></span></div>
		</div>

	</div>

	<a name="start_here"></a>
	<div id="page-body">
		
<h2><a href="viewtopic.php@f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Compiler Issues</a></h2>
<!-- NOTE: remove the style="display: none" when you want to have the forum description on the topic body --><div style="display: none !important;">Building a delta throttle? Make a thread here to share your progress and ask questions.<br /></div>

<div class="topic-actions">

	<div class="buttons">
	
		<div class="reply-icon"><a href="posting.php@mode=reply&amp;f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Post a reply"><span></span>Post a reply</a></div>
	
	</div>

	
		<div class="search-box">
			<form method="get" id="topic-search" action="search.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html">
			<fieldset>
				<input class="inputbox search tiny"  type="text" name="keywords" id="search_keywords" size="20" value="Search this topic…" onclick="if(this.value=='Search this topic…')this.value='';" onblur="if(this.value=='')this.value='Search this topic…';" />
				<input class="button2" type="submit" value="Search" />
				<input type="hidden" name="t" value="118" />
<input type="hidden" name="sf" value="msgonly" />
<input type="hidden" name="sid" value="2da7d3261aa1b35db93cfc0fa069564e" />

			</fieldset>
			</form>
		</div>
	
		<div class="pagination">
			15 posts
			 &bull; <a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="jumpto(); return false;" title="Click to jump to page…">Page <strong>1</strong> of <strong>2</strong></a> &bull; <span><strong>1</strong><span class="page-sep">, </span><a href="viewtopic.php@f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e&amp;start=10.html">2</a></span>
		</div>
	

</div>
<div class="clear"></div>


	<div id="p356" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=356&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 class="first"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p356">Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=356&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p356"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a></strong> &raquo; Thu Apr 09, 2015 5:23 pm </p>

			

			<div class="content">I missed the memo that only an earlier version of the Arduino compiler will compile the source code, so I've been working on figuring out how to &quot;fix&quot; the source to get it to work.  For the most part it was just figuring out what the latest version from Arduino was missing from the Delta Throttle source files &amp; adding it back in.  Now I've got the code to compile.  We'll see if it'll work once I get the code values to match my setup(I missed wired a couple of things that'll be easier to fix in code).  Once that's done I plan on cleaning up the code by removing all the unnecessary code and moving some things around.  When I get it done I'll post it here.</div>

			

		</div>

		
			<dl class="postprofile" id="profile356">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 14</dd><dd><strong>Joined:</strong> Thu Apr 09, 2015 12:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p368" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p368">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p368"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a></strong> &raquo; Sun Apr 12, 2015 2:20 pm </p>

			

			<div class="content">I've gotten the code rewritten for the latest version of the Arduino Compiler &amp; cleaned it up a bit.  I've also added an Enable/Disable feature, which will re-initialize the throttle when enabled.  I haven't tested it yet, so things could change.  But this should help anyone out who didn't grab the older compiler.<br /><br />Here's the Sketch.  Some of the cosmetic changes I made was to make as many values constant as I could.  I did the same to the Pin usage as well, which should make it easier to adjust to different wirings.  At the moment I'm only reading 3 digital pins, so that'll need to be increased/decreased to match how many buttons you wish to have.  If you don't want to have the Enable/Disable feature, you'll also need to set the &quot;enabled&quot; &amp; &quot;needInit&quot; to TRUE.<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>const bool DEBUG = false;&nbsp; // set to true to debug the raw values<br /><br />//Geometry<br />const float handle_rad = 1.75;&nbsp; &nbsp; &nbsp;// end effector<br />const float base_rad = 1.75;&nbsp; &nbsp; &nbsp;// base<br />const float pushrod_lng = 3.5;<br />const float pivot_lng = 2.25;<br /><br />//Configuration<br />const float deadzone = 0.1;&nbsp; // smaller values will be set to 0<br />const int gain = 150;<br /><br />&nbsp;// trigonometric constants<br />const float sqrt3 = sqrt(3.0);<br />const float pi = 3.141592653;&nbsp; &nbsp; // PI<br />const float sin120 = sqrt3/2.0;&nbsp; &nbsp;<br />const float cos120 = -0.5;&nbsp; &nbsp; &nbsp; &nbsp; <br />const float tan60 = sqrt3;<br />const float sin30 = 0.5;<br />const float tan30 = 1/sqrt3;<br /><br />//Pins Used<br />const int btn1Pin = 1;<br />const int btn2Pin = 2;<br />const int btn3Pin = 3;<br />const int ADC1Pin = A0; //Bottom Pot<br />const int ADC2Pin = A1; //Top/Right Pot<br />const int ADC3Pin = A2; //Top/Left<br />const int enabledLED = 6;<br />const int enabledInterrupt = 7;<br /><br />//Global Values<br />volatile bool enabled = false;<br />volatile bool needInit = false;<br />float xZero, yZero, zZero;<br />float xValue, yValue, zValue;<br /><br />void setup() {<br />&nbsp; pinMode(ADC1Pin, INPUT);<br />&nbsp; pinMode(ADC2Pin, INPUT);<br />&nbsp; pinMode(ADC3Pin, INPUT);<br />&nbsp; pinMode(btn1Pin, INPUT);<br />&nbsp; pinMode(btn2Pin, INPUT);<br />&nbsp; pinMode(btn3Pin, INPUT);<br />&nbsp; digitalWrite(btn1Pin, HIGH);<br />&nbsp; digitalWrite(btn2Pin, HIGH);<br />&nbsp; digitalWrite(btn3Pin, HIGH);<br />&nbsp; attachInterrupt(enabledInterrupt, interrupt, FALLING);<br /><br />&nbsp; if (DEBUG) {<br />&nbsp; &nbsp; Serial.begin(9600);<br />&nbsp; }<br />}<br /><br />void initialize() <br />{<br />&nbsp; &nbsp; xZero = 0;<br />&nbsp; &nbsp; yZero = 0;<br />&nbsp; &nbsp; zZero = zValue;<br />&nbsp; &nbsp; needInit = false;<br />}<br /><br />void loop() {<br />&nbsp; int xVal = 0;<br />&nbsp; int yVal = 0;<br />&nbsp; int zVal = 0;<br />&nbsp; int btn1 = LOW;<br />&nbsp; int btn2 = LOW;<br />&nbsp; int btn3 = LOW;<br />&nbsp; <br />&nbsp; if(enabled) <br />&nbsp; {<br />&nbsp; &nbsp; getForwardKinematic();<br /><br />&nbsp; &nbsp; if(needInit) initialize();<br />&nbsp; <br />&nbsp; &nbsp; btn1 = !digitalRead(btn1Pin);<br />&nbsp; &nbsp; btn2 = !digitalRead(btn2Pin);<br />&nbsp; &nbsp; btn3 = !digitalRead(btn3Pin);<br />&nbsp; <br />&nbsp; &nbsp; xVal = GetAxisValue(xValue, xZero, gain, deadzone, -100, 100);<br />&nbsp; &nbsp; yVal = GetAxisValue(yValue, yZero, gain, deadzone, -100, 100);<br />&nbsp; &nbsp; zVal = GetAxisValue(yValue, zZero, gain, deadzone, -100, 100);&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; if (DEBUG) {<br />&nbsp; &nbsp; &nbsp; Serial.print(&quot;X: &quot;);<br />&nbsp; &nbsp; &nbsp; Serial.println(xVal);<br />&nbsp; &nbsp; &nbsp; Serial.print(&quot;Y: &quot;);<br />&nbsp; &nbsp; &nbsp; Serial.println(yVal);<br />&nbsp; &nbsp; &nbsp; Serial.print(&quot;Z: &quot;);<br />&nbsp; &nbsp; &nbsp; Serial.println(zVal);<br />&nbsp; &nbsp; &nbsp; Serial.print(&quot;B1: &quot;);<br />&nbsp; &nbsp; &nbsp; Serial.println(btn1);<br />&nbsp; &nbsp; &nbsp; Serial.print(&quot;B2: &quot;);<br />&nbsp; &nbsp; &nbsp; Serial.println(btn2);<br />&nbsp; &nbsp; &nbsp; Serial.print(&quot;B3: &quot;);<br />&nbsp; &nbsp; &nbsp; Serial.println(btn3);<br />&nbsp; &nbsp; }<br />&nbsp; }<br />&nbsp; <br />&nbsp; if(enabled) <br />&nbsp; {<br />&nbsp; &nbsp; Joystick.SetAxis(Joystick_::XAXIS, map(xVal, -100, 100, 0, 255));<br />&nbsp; &nbsp; Joystick.SetAxis(Joystick_::YAXIS, map(yVal, -100, 100, 0, 255));<br />&nbsp; &nbsp; Joystick.SetAxis(Joystick_::ZAXIS, map(zVal, -100, 100, 0, 255));<br />&nbsp; &nbsp; Joystick.SetButton(1, btn1 == HIGH);<br />&nbsp; &nbsp; Joystick.SetButton(2, btn2 == HIGH);<br />&nbsp; &nbsp; Joystick.SetButton(3, btn3 == HIGH);<br />&nbsp; &nbsp; digitalWrite(enabledLED, HIGH);<br />&nbsp; }<br />&nbsp; else <br />&nbsp; {<br />&nbsp; &nbsp; Joystick.SetAxis(Joystick_::XAXIS, 0);<br />&nbsp; &nbsp; Joystick.SetAxis(Joystick_::YAXIS, 0);<br />&nbsp; &nbsp; Joystick.SetAxis(Joystick_::ZAXIS, 0);<br />&nbsp; &nbsp; Joystick.SetButton(1, false);<br />&nbsp; &nbsp; Joystick.SetButton(2, false);<br />&nbsp; &nbsp; Joystick.SetButton(3, false);<br />&nbsp; &nbsp; digitalWrite(enabledLED, LOW);<br />&nbsp; }<br /><br />&nbsp; // Send to USB<br />&nbsp; Joystick.ReportState();<br /><br />&nbsp; if (DEBUG)<br />&nbsp; &nbsp; delay(1000);<br />}<br /><br />void interrupt() <br />{<br />&nbsp; if(enabled) <br />&nbsp; {<br />&nbsp; &nbsp; enabled = false;<br />&nbsp; }<br />&nbsp; else<br />&nbsp; {<br />&nbsp; &nbsp; enabled = true;<br />&nbsp; &nbsp; needInit = true;<br />&nbsp; }&nbsp; <br />}<br />//The delta kinematic math<br />//You shouldn't need to change anything here.<br />void getForwardKinematic()<br />{<br />&nbsp; //p1 is the bottom joint, p2 is the top right, p3 is the top left<br />&nbsp; int p1ADC = analogRead(ADC1Pin);<br />&nbsp; int p2ADC = analogRead(ADC2Pin);<br />&nbsp; int p3ADC = analogRead(ADC3Pin);<br /><br /><br />&nbsp; //get the angle of each joint in radians<br />&nbsp; float theta1 = (p1ADC - 60) * 0.003475;<br />&nbsp; float theta2 = (p2ADC - 60) * 0.003475;<br />&nbsp; float theta3 = (p3ADC - 60) * 0.003475;<br /><br />&nbsp; float t = base_rad - handle_rad;<br />&nbsp; float y1 = -(t + pivot_lng * cos(theta1));<br />&nbsp; float z1 = pivot_lng * sin(theta1);<br /><br />&nbsp; float y2 = (t + pivot_lng * cos(theta2)) * sin30;<br />&nbsp; float x2 = y2 * tan60;<br />&nbsp; float z2 = pivot_lng * sin(theta2);<br /><br />&nbsp; float y3 = (t + pivot_lng * cos(theta3)) * sin30;<br />&nbsp; float x3 = -y3 * tan60;<br />&nbsp; float z3 = pivot_lng * sin(theta3);<br /><br />&nbsp; float dnm = (y2 - y1) * x3 - (y3 - y1) * x2;<br /><br />&nbsp; float w1 = y1 * y1 + z1 * z1;<br />&nbsp; float w2 = x2 * x2 + y2 * y2 + z2 * z2;<br />&nbsp; float w3 = x3 * x3 + y3 * y3 + z3 * z3;<br /><br />&nbsp; // x = (a1*z + b1)/dnm<br />&nbsp; float a1 = (z2 - z1) * (y3 - y1) - (z3 - z1) * (y2 - y1);<br />&nbsp; float b1 = -((w2 - w1) * (y3 - y1) - (w3 - w1) * (y2 - y1)) / 2.0;<br /><br />&nbsp; // y = (a2*z + b2)/dnm;<br />&nbsp; float a2 = -(z2 - z1) * x3 + (z3 - z1) * x2;<br />&nbsp; float b2 = ((w2 - w1) * x3 - (w3 - w1) * x2) / 2.0;<br /><br />&nbsp; // a*z^2 + b*z + c = 0<br />&nbsp; float a = a1 * a1 + a2 * a2 + dnm * dnm;<br />&nbsp; float b = 2 * (a1 * b1 + a2 * (b2 - y1 * dnm) - z1 * dnm * dnm);<br />&nbsp; float c = (b2 - y1 * dnm) * (b2 - y1 * dnm) + b1 * b1 + dnm * dnm * (z1 * z1 - pushrod_lng * pushrod_lng);<br /><br />&nbsp; // discriminant<br />&nbsp; float d = b * b - 4.0 * a * c;<br /><br />&nbsp; zValue = 0.5 * (-b + sqrt(d)) / a;<br />&nbsp; xValue = (a1 * zValue + b1) / dnm;<br />&nbsp; yValue = (a2 * zValue + b2) / dnm;<br /><br />&nbsp; if (DEBUG) {<br />&nbsp; &nbsp; Serial.print(&quot;T1: &quot;);<br />&nbsp; &nbsp; Serial.println(theta1);<br />&nbsp; &nbsp; Serial.print(&quot;T2: &quot;);<br />&nbsp; &nbsp; Serial.println(theta2);<br />&nbsp; &nbsp; Serial.print(&quot;T3: &quot;);<br />&nbsp; &nbsp; Serial.println(theta3);<br />&nbsp; &nbsp; Serial.print(&quot;Z1: &quot;);<br />&nbsp; &nbsp; Serial.println(z1);<br />&nbsp; &nbsp; Serial.print(&quot;Z2: &quot;);<br />&nbsp; &nbsp; Serial.println(z2);<br />&nbsp; &nbsp; Serial.print(&quot;Z3: &quot;);<br />&nbsp; &nbsp; Serial.println(z3);<br />&nbsp; &nbsp; Serial.print(&quot;DNM: &quot;);<br />&nbsp; &nbsp; Serial.println(dnm);<br /><br />&nbsp; }<br />}<br /><br />float GetAxisValue(float value, float zero, float gain, float deadZone, float minValue, float maxValue) <br />{<br />&nbsp; &nbsp; float rtValue = value - zero;<br />&nbsp; &nbsp;<br />&nbsp; &nbsp; if (rtValue &lt; -1 * deadZone)<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; rtValue += deadZone;<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; else if (rtValue &gt; deadZone)<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; rtValue -= deadZone;<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; else<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; rtValue = 0;<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; //apply gain<br />&nbsp; &nbsp; rtValue = rtValue * gain;<br />&nbsp; <br />&nbsp; &nbsp; //constrain outputs to +- 100<br />&nbsp; &nbsp; rtValue = constrain(rtValue, minValue, maxValue);&nbsp; <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; return rtValue;<br />}</code></dd></dl><br /><br />From the USBAPI.h I removed the Keyboard &amp; Mouse functionality, and added an improved Joystick class.  The Joystick class contains methods for setting each axis(6 total) &amp; up to 32 buttons.  <br /><dl class="codebox"><dt>Code: <a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>/*<br />&nbsp; USBAPI.h<br />&nbsp; Copyright (c) 2005-2014 Arduino.&nbsp; All right reserved.<br /><br />&nbsp; This library is free software; you can redistribute it and/or<br />&nbsp; modify it under the terms of the GNU Lesser General Public<br />&nbsp; License as published by the Free Software Foundation; either<br />&nbsp; version 2.1 of the License, or (at your option) any later version.<br /><br />&nbsp; This library is distributed in the hope that it will be useful,<br />&nbsp; but WITHOUT ANY WARRANTY; without even the implied warranty of<br />&nbsp; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the GNU<br />&nbsp; Lesser General Public License for more details.<br /><br />&nbsp; You should have received a copy of the GNU Lesser General Public<br />&nbsp; License along with this library; if not, write to the Free Software<br />&nbsp; Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA&nbsp; 02110-1301&nbsp; USA<br />*/<br /><br />#ifndef __USBAPI__<br />#define __USBAPI__<br /><br />#include &lt;inttypes.h&gt;<br />#include &lt;avr/pgmspace.h&gt;<br />#include &lt;avr/eeprom.h&gt;<br />#include &lt;avr/interrupt.h&gt;<br />#include &lt;util/delay.h&gt;<br /><br />typedef unsigned char u8;<br />typedef unsigned short u16;<br />typedef unsigned long u32;<br /><br />#include &quot;Arduino.h&quot;<br /><br />#if defined(USBCON)<br /><br />#include &quot;USBDesc.h&quot;<br />#include &quot;USBCore.h&quot;<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;USB<br /><br />class USBDevice_<br />{<br />public:<br />&nbsp; &nbsp;USBDevice_();<br />&nbsp; &nbsp;bool configured();<br /><br />&nbsp; &nbsp;void attach();<br />&nbsp; &nbsp;void detach();&nbsp; &nbsp;// Serial port goes down too...<br />&nbsp; &nbsp;void poll();<br />};<br />extern USBDevice_ USBDevice;<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;Serial over CDC (Serial1 is the physical port)<br /><br />struct ring_buffer;<br /><br />#if (RAMEND &lt; 1000)<br />#define SERIAL_BUFFER_SIZE 16<br />#else<br />#define SERIAL_BUFFER_SIZE 64<br />#endif<br /><br />class Serial_ : public Stream<br />{<br />private:<br />&nbsp; &nbsp;int peek_buffer;<br />public:<br />&nbsp; &nbsp;Serial_() { peek_buffer = -1; };<br />&nbsp; &nbsp;void begin(unsigned long);<br />&nbsp; &nbsp;void begin(unsigned long, uint8_t);<br />&nbsp; &nbsp;void end(void);<br /><br />&nbsp; &nbsp;virtual int available(void);<br />&nbsp; &nbsp;virtual int peek(void);<br />&nbsp; &nbsp;virtual int read(void);<br />&nbsp; &nbsp;virtual void flush(void);<br />&nbsp; &nbsp;virtual size_t write(uint8_t);<br />&nbsp; &nbsp;virtual size_t write(const uint8_t*, size_t);<br />&nbsp; &nbsp;using Print::write; // pull in write(str) and write(buf, size) from Print<br />&nbsp; &nbsp;operator bool();<br /><br />&nbsp; &nbsp;volatile uint8_t _rx_buffer_head;<br />&nbsp; &nbsp;volatile uint8_t _rx_buffer_tail;<br />&nbsp; &nbsp;unsigned char _rx_buffer&#91;SERIAL_BUFFER_SIZE&#93;;<br />};<br />extern Serial_ Serial;<br /><br />#define HAVE_CDCSERIAL<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;Joystick<br />//&nbsp; Implemented in HID.cpp<br />//&nbsp; The list of parameters here needs to match the implementation in HID.cpp<br /><br />class Joystick_<br />{&nbsp; &nbsp;<br />&nbsp; &nbsp;private:<br />&nbsp; &nbsp;&nbsp; &nbsp;uint32_t buttons;<br />&nbsp; &nbsp;&nbsp; &nbsp;uint8_t axes&#91;6&#93;;<br />&nbsp; &nbsp;public:<br />&nbsp; &nbsp;&nbsp; &nbsp;Joystick_();<br />&nbsp; &nbsp;&nbsp; &nbsp;void ReportState();<br />&nbsp; &nbsp;&nbsp; &nbsp;void SetAxis(int Axis, uint8_t value);<br />&nbsp; &nbsp;&nbsp; &nbsp;void SetButton(int Button, bool value);<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;&nbsp; &nbsp;static const int XAXIS = 0;<br />&nbsp; &nbsp;&nbsp; &nbsp;static const int YAXIS = 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;static const int ZAXIS = 2;<br />&nbsp; &nbsp;&nbsp; &nbsp;static const int RXAXIS = 3;<br />&nbsp; &nbsp;&nbsp; &nbsp;static const int RYAXIS = 4;<br />&nbsp; &nbsp;&nbsp; &nbsp;static const int RZAXIS = 5;<br />};<br />extern Joystick_ Joystick;<br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;Low level API<br /><br />typedef struct<br />{<br />&nbsp; &nbsp;uint8_t bmRequestType;<br />&nbsp; &nbsp;uint8_t bRequest;<br />&nbsp; &nbsp;uint8_t wValueL;<br />&nbsp; &nbsp;uint8_t wValueH;<br />&nbsp; &nbsp;uint16_t wIndex;<br />&nbsp; &nbsp;uint16_t wLength;<br />} Setup;<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;HID 'Driver'<br /><br />int&nbsp; &nbsp;&nbsp; &nbsp;HID_GetInterface(uint8_t* interfaceNum);<br />int&nbsp; &nbsp;&nbsp; &nbsp;HID_GetDescriptor(int i);<br />bool&nbsp; &nbsp;HID_Setup(Setup&amp; setup);<br />void&nbsp; &nbsp;HID_SendReport(uint8_t id, const void* data, int len);<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;MSC 'Driver'<br /><br />int&nbsp; &nbsp;&nbsp; &nbsp;MSC_GetInterface(uint8_t* interfaceNum);<br />int&nbsp; &nbsp;&nbsp; &nbsp;MSC_GetDescriptor(int i);<br />bool&nbsp; &nbsp;MSC_Setup(Setup&amp; setup);<br />bool&nbsp; &nbsp;MSC_Data(uint8_t rx,uint8_t tx);<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;CSC 'Driver'<br /><br />int&nbsp; &nbsp;&nbsp; &nbsp;CDC_GetInterface(uint8_t* interfaceNum);<br />int&nbsp; &nbsp;&nbsp; &nbsp;CDC_GetDescriptor(int i);<br />bool&nbsp; &nbsp;CDC_Setup(Setup&amp; setup);<br /><br />//================================================================================<br />//================================================================================<br /><br />#define TRANSFER_PGM&nbsp; &nbsp;&nbsp; &nbsp;0x80<br />#define TRANSFER_RELEASE&nbsp; &nbsp;0x40<br />#define TRANSFER_ZERO&nbsp; &nbsp;&nbsp; &nbsp;0x20<br /><br />int USB_SendControl(uint8_t flags, const void* d, int len);<br />int USB_RecvControl(void* d, int len);<br /><br />uint8_t&nbsp; &nbsp;USB_Available(uint8_t ep);<br />int USB_Send(uint8_t ep, const void* data, int len);&nbsp; &nbsp;// blocking<br />int USB_Recv(uint8_t ep, void* data, int len);&nbsp; &nbsp;&nbsp; &nbsp;// non-blocking<br />int USB_Recv(uint8_t ep);&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// non-blocking<br />void USB_Flush(uint8_t ep);<br /><br />#endif<br /><br />#endif /* if defined(USBCON) */<br /></code></dd></dl><br /><br />For the HID.cpp I did quite a bit of changing.  First off, my HID Descriptor is setup to only register 16 buttons, but has 5 axes.  This is because I have a PSP thumb stick with 2 additional axes &amp; it's easier to keep the number of buttons as multiples of 8.  I tried to keep the hat switch in the HID Descriptor, but when I did it was 67 bytes long, which is a problem because I don't know how to report an HID Descriptor larger than 64 bytes(which is the default).  Since the 2 extra axes take up 4 bytes, if you wanted to replace them with the Hat Stick you should be able to.  Also, even though the Joystick class will allow 6 axes &amp; 32 buttons, my implementation will only send 5 axes &amp; 16 bytes.<br /><dl class="codebox"><dt>Code: <a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>/* Copyright (c) 2011, Peter Barrett&nbsp; <br />**&nbsp; <br />** Permission to use, copy, modify, and/or distribute this software for&nbsp; <br />** any purpose with or without fee is hereby granted, provided that the&nbsp; <br />** above copyright notice and this permission notice appear in all copies.&nbsp; <br />** <br />** THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL&nbsp; <br />** WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED&nbsp; <br />** WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR&nbsp; <br />** BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES&nbsp; <br />** OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,&nbsp; <br />** WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,&nbsp; <br />** ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS&nbsp; <br />** SOFTWARE.&nbsp; <br />*/<br /><br />#include &quot;USBAPI.h&quot;<br /><br />#if defined(USBCON)<br />#ifdef HID_ENABLED<br /><br />//#define RAWHID_ENABLED<br /><br />Joystick_ Joystick;<br /><br />//================================================================================<br />//================================================================================<br /><br />//&nbsp; &nbsp;HID report descriptor<br /><br />#define LSB(_x) ((_x) &amp; 0xFF)<br />#define MSB(_x) ((_x) &gt;&gt; 8)<br /><br />#define RAWHID_USAGE_PAGE&nbsp; &nbsp;0xFFC0<br />#define RAWHID_USAGE&nbsp; &nbsp;&nbsp; &nbsp;0x0C00<br />#define RAWHID_TX_SIZE 64<br />#define RAWHID_RX_SIZE 64<br /><br />extern const u8 _hidReportDescriptor&#91;&#93; PROGMEM;<br />const u8 _hidReportDescriptor&#91;&#93; = {&nbsp; &nbsp; <br />&nbsp; &nbsp; 0x05, 0x01,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // USAGE_PAGE (Generic Desktop)<br />&nbsp; &nbsp; 0x09, 0x04,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // USAGE (Joystick)<br />&nbsp; &nbsp; 0xa1, 0x01,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // COLLECTION (Application)<br />&nbsp; &nbsp; 0xa1, 0x00,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp;COLLECTION (Physical)<br />&nbsp; &nbsp; 0x05, 0x09,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE_PAGE (Button)<br />&nbsp; &nbsp; 0x19, 0x01,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE_MINIMUM (Button 1)<br />&nbsp; &nbsp; 0x29, 0x10,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE_MAXIMUM (Button 16)<br />&nbsp; &nbsp; 0x15, 0x00,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;LOGICAL_MINIMUM (0)<br />&nbsp; &nbsp; 0x25, 0x01,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;LOGICAL_MAXIMUM (1)<br />&nbsp; &nbsp; 0x95, 0x10,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;REPORT_COUNT (16)<br />&nbsp; &nbsp; 0x75, 0x01,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;REPORT_SIZE (1)<br />&nbsp; &nbsp; 0x81, 0x02,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;INPUT (Data,Var,Abs)<br />&nbsp; &nbsp; 0x05, 0x01,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE_PAGE (Generic Desktop)<br />&nbsp; &nbsp; 0x09, 0x30,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE (X)<br />&nbsp; &nbsp; 0x09, 0x31,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE (Y)<br />&nbsp; &nbsp; 0x09, 0x32,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE (Z)<br />&nbsp; &nbsp; 0x09, 0x33,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE (Rx)<br />&nbsp; &nbsp; 0x09, 0x34,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;USAGE (Ry)<br />&nbsp; &nbsp; 0x15, 0x81,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;LOGICAL_MINIMUM (-127)<br />&nbsp; &nbsp; 0x25, 0x7f,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;LOGICAL_MAXIMUM (127)<br />&nbsp; &nbsp; 0x75, 0x08,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;REPORT_SIZE (8)<br />&nbsp; &nbsp; 0x95, 0x05,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;REPORT_COUNT (5)<br />&nbsp; &nbsp; 0x81, 0x02,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp; &nbsp;INPUT (Data,Var,Abs)<br />&nbsp; &nbsp; 0xc0,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; &nbsp;END_COLLECTION<br />&nbsp; &nbsp; 0xc0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// END_COLLECTION<br />};<br /><br />extern const HIDDescriptor _hidInterface PROGMEM;<br />const HIDDescriptor _hidInterface =<br />{<br />&nbsp; &nbsp;D_INTERFACE(HID_INTERFACE,1,3,0,0),<br />&nbsp; &nbsp;D_HIDREPORT(sizeof(_hidReportDescriptor)),<br />&nbsp; &nbsp;D_ENDPOINT(USB_ENDPOINT_IN (HID_ENDPOINT_INT),USB_ENDPOINT_TYPE_INTERRUPT,0x40,0x01)<br />};<br /><br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;Driver<br /><br />u8 _hid_protocol = 1;<br />u8 _hid_idle = 1;<br /><br />#define WEAK __attribute__ ((weak))<br /><br />int WEAK HID_GetInterface(u8* interfaceNum)<br />{<br />&nbsp; &nbsp;interfaceNum&#91;0&#93; += 1;&nbsp; &nbsp;// uses 1<br />&nbsp; &nbsp;return USB_SendControl(TRANSFER_PGM,&amp;_hidInterface,sizeof(_hidInterface));<br />}<br /><br />int WEAK HID_GetDescriptor(int /* i */)<br />{<br />&nbsp; &nbsp;return USB_SendControl(TRANSFER_PGM,_hidReportDescriptor,sizeof(_hidReportDescriptor));<br />}<br /><br />void WEAK HID_SendReport(u8 id, const void* data, int len)<br />{<br />&nbsp; &nbsp;USB_Send(HID_TX, &amp;id, 1);<br />&nbsp; &nbsp;USB_Send(HID_TX | TRANSFER_RELEASE,data,len);<br />}<br /><br />bool WEAK HID_Setup(Setup&amp; setup)<br />{<br />&nbsp; &nbsp;u8 r = setup.bRequest;<br />&nbsp; &nbsp;u8 requestType = setup.bmRequestType;<br />&nbsp; &nbsp;if (REQUEST_DEVICETOHOST_CLASS_INTERFACE == requestType)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;if (HID_GET_REPORT == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;//HID_GetReport();<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return true;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;if (HID_GET_PROTOCOL == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;//Send8(_hid_protocol);&nbsp; &nbsp;// TODO<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return true;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;if (REQUEST_HOSTTODEVICE_CLASS_INTERFACE == requestType)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;if (HID_SET_PROTOCOL == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;_hid_protocol = setup.wValueL;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return true;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;if (HID_SET_IDLE == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;_hid_idle = setup.wValueL;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return true;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;return false;<br />}<br />//================================================================================<br />//================================================================================<br />//&nbsp; &nbsp;Joystick<br />//&nbsp; Usage: Joystick.move(inputs go here)<br />//<br />//&nbsp; The report data format must match the one defined in the descriptor exactly<br />//&nbsp; or it either won't work, or the pc will make a mess of unpacking the data<br />//<br />Joystick_::Joystick_()<br />{<br />}<br /><br />void Joystick_::SetAxis(int Axis, uint8_t value) <br />{<br />&nbsp; &nbsp;if(Axis &gt;= 0 &amp;&amp; Axis &lt; 6) <br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;axes&#91;Axis&#93; = value;<br />&nbsp; &nbsp;}<br />}<br /><br />void Joystick_::SetButton(int Button, bool value) <br />{<br />&nbsp; &nbsp;if(Button &gt; 0 &amp;&amp; Button &lt;= 32) <br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;uint32_t temp = 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;temp &lt;&lt;= (Button - 1);<br />&nbsp; &nbsp;&nbsp; &nbsp;if(value) <br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;buttons |= temp;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else <br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;temp = ~temp;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;buttons &amp;= temp;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;}<br />}<br /><br />#define joyBytes 7<br /><br />void Joystick_::ReportState()<br />{<br />&nbsp; &nbsp;uint8_t data&#91;joyBytes&#93;;<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;memcpy(data, &amp;buttons, 2);&nbsp; &nbsp;<br />&nbsp; &nbsp;memcpy(data+2, axes, 5);&nbsp; &nbsp;<br /><br />&nbsp; &nbsp;USB_Send(HID_TX | TRANSFER_RELEASE,data,joyBytes);<br />}<br /><br />#endif<br /><br />#endif /* if defined(USBCON) */<br /></code></dd></dl></div>

			

		</div>

		
			<dl class="postprofile" id="profile368">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 14</dd><dd><strong>Joined:</strong> Thu Apr 09, 2015 12:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p369" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=369&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p369">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=369&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p369"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a></strong> &raquo; Sun Apr 12, 2015 2:26 pm </p>

			

			<div class="content">I didn't change the USBCore.cpp much from what comes with the Compiler.  All I did was add the code so that the device would register itself as a &quot;Delta Throttle&quot;.<br /><br /><dl class="codebox"><dt>Code: <a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code><br />/* Copyright (c) 2010, Peter Barrett&nbsp; <br />**&nbsp; <br />** Permission to use, copy, modify, and/or distribute this software for&nbsp; <br />** any purpose with or without fee is hereby granted, provided that the&nbsp; <br />** above copyright notice and this permission notice appear in all copies.&nbsp; <br />** <br />** THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL&nbsp; <br />** WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED&nbsp; <br />** WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR&nbsp; <br />** BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES&nbsp; <br />** OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,&nbsp; <br />** WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,&nbsp; <br />** ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS&nbsp; <br />** SOFTWARE.&nbsp; <br />*/<br /><br />#include &quot;USBAPI.h&quot;<br /><br />#if defined(USBCON)<br /><br />#define EP_TYPE_CONTROL&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;0x00<br />#define EP_TYPE_BULK_IN&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;0x81<br />#define EP_TYPE_BULK_OUT&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;0x80<br />#define EP_TYPE_INTERRUPT_IN&nbsp; &nbsp;&nbsp; &nbsp;0xC1<br />#define EP_TYPE_INTERRUPT_OUT&nbsp; &nbsp;&nbsp; &nbsp;0xC0<br />#define EP_TYPE_ISOCHRONOUS_IN&nbsp; &nbsp;&nbsp; &nbsp;0x41<br />#define EP_TYPE_ISOCHRONOUS_OUT&nbsp; &nbsp;&nbsp; &nbsp;0x40<br /><br />/** Pulse generation counters to keep track of the number of milliseconds remaining for each pulse type */<br />#define TX_RX_LED_PULSE_MS 100<br />volatile u8 TxLEDPulse; /**&lt; Milliseconds remaining for data Tx LED pulse */<br />volatile u8 RxLEDPulse; /**&lt; Milliseconds remaining for data Rx LED pulse */<br /><br />//==================================================================<br />//==================================================================<br /><br />extern const u16 STRING_LANGUAGE&#91;&#93; PROGMEM;<br />extern const u8 STRING_PRODUCT&#91;&#93; PROGMEM;<br />extern const u8 STRING_MANUFACTURER&#91;&#93; PROGMEM;<br />extern const DeviceDescriptor USB_DeviceDescriptor PROGMEM;<br />extern const DeviceDescriptor USB_DeviceDescriptorA PROGMEM;<br /><br />const u16 STRING_LANGUAGE&#91;2&#93; = {<br />&nbsp; &nbsp;(3&lt;&lt;8) | (2+2),<br />&nbsp; &nbsp;0x0409&nbsp; &nbsp;// English<br />};<br /><br />#ifndef USB_PRODUCT<br />// If no product is provided, use USB IO Board<br />#define USB_PRODUCT&nbsp; &nbsp; &nbsp;&quot;Delta Throttle&quot;<br />#endif<br /><br />const u8 STRING_PRODUCT&#91;&#93; PROGMEM = &quot;Delta Throttle&quot;;<br /><br />#if USB_VID == 0x2341<br />#&nbsp; if defined(USB_MANUFACTURER)<br />#&nbsp; &nbsp; undef USB_MANUFACTURER<br />#&nbsp; endif<br />#&nbsp; define USB_MANUFACTURER &quot;Arduino LLC&quot;<br />#elif USB_VID == 0x1b4f<br />#&nbsp; if defined(USB_MANUFACTURER)<br />#&nbsp; &nbsp; undef USB_MANUFACTURER<br />#&nbsp; endif<br />#&nbsp; define USB_MANUFACTURER &quot;SparkFun&quot;<br />#elif !defined(USB_MANUFACTURER)<br />// Fall through to unknown if no manufacturer name was provided in a macro<br />#&nbsp; define USB_MANUFACTURER &quot;Unknown&quot;<br />#endif<br /><br />const u8 STRING_MANUFACTURER&#91;&#93; PROGMEM = USB_MANUFACTURER;<br /><br /><br />#ifdef CDC_ENABLED<br />#define DEVICE_CLASS 0x02<br />#else<br />#define DEVICE_CLASS 0x00<br />#endif<br /><br />//&nbsp; &nbsp;DEVICE DESCRIPTOR<br />const DeviceDescriptor USB_DeviceDescriptor =<br />&nbsp; &nbsp;D_DEVICE(0x00,0x00,0x00,64,USB_VID,USB_PID,0x100,IMANUFACTURER,IPRODUCT,0,1);<br /><br />const DeviceDescriptor USB_DeviceDescriptorA =<br />&nbsp; &nbsp;D_DEVICE(DEVICE_CLASS,0x00,0x00,64,USB_VID,USB_PID,0x100,IMANUFACTURER,IPRODUCT,0,1);<br /><br />//==================================================================<br />//==================================================================<br /><br />volatile u8 _usbConfiguration = 0;<br /><br />static inline void WaitIN(void)<br />{<br />&nbsp; &nbsp;while (!(UEINTX &amp; (1&lt;&lt;TXINI)))<br />&nbsp; &nbsp;&nbsp; &nbsp;;<br />}<br /><br />static inline void ClearIN(void)<br />{<br />&nbsp; &nbsp;UEINTX = ~(1&lt;&lt;TXINI);<br />}<br /><br />static inline void WaitOUT(void)<br />{<br />&nbsp; &nbsp;while (!(UEINTX &amp; (1&lt;&lt;RXOUTI)))<br />&nbsp; &nbsp;&nbsp; &nbsp;;<br />}<br /><br />static inline u8 WaitForINOrOUT()<br />{<br />&nbsp; &nbsp;while (!(UEINTX &amp; ((1&lt;&lt;TXINI)|(1&lt;&lt;RXOUTI))))<br />&nbsp; &nbsp;&nbsp; &nbsp;;<br />&nbsp; &nbsp;return (UEINTX &amp; (1&lt;&lt;RXOUTI)) == 0;<br />}<br /><br />static inline void ClearOUT(void)<br />{<br />&nbsp; &nbsp;UEINTX = ~(1&lt;&lt;RXOUTI);<br />}<br /><br />void Recv(volatile u8* data, u8 count)<br />{<br />&nbsp; &nbsp;while (count--)<br />&nbsp; &nbsp;&nbsp; &nbsp;*data++ = UEDATX;<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;RXLED1;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// light the RX LED<br />&nbsp; &nbsp;RxLEDPulse = TX_RX_LED_PULSE_MS;&nbsp; &nbsp;<br />}<br /><br />static inline u8 Recv8()<br />{<br />&nbsp; &nbsp;RXLED1;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// light the RX LED<br />&nbsp; &nbsp;RxLEDPulse = TX_RX_LED_PULSE_MS;<br /><br />&nbsp; &nbsp;return UEDATX;&nbsp; &nbsp;<br />}<br /><br />static inline void Send8(u8 d)<br />{<br />&nbsp; &nbsp;UEDATX = d;<br />}<br /><br />static inline void SetEP(u8 ep)<br />{<br />&nbsp; &nbsp;UENUM = ep;<br />}<br /><br />static inline u8 FifoByteCount()<br />{<br />&nbsp; &nbsp;return UEBCLX;<br />}<br /><br />static inline u8 ReceivedSetupInt()<br />{<br />&nbsp; &nbsp;return UEINTX &amp; (1&lt;&lt;RXSTPI);<br />}<br /><br />static inline void ClearSetupInt()<br />{<br />&nbsp; &nbsp;UEINTX = ~((1&lt;&lt;RXSTPI) | (1&lt;&lt;RXOUTI) | (1&lt;&lt;TXINI));<br />}<br /><br />static inline void Stall()<br />{<br />&nbsp; &nbsp;UECONX = (1&lt;&lt;STALLRQ) | (1&lt;&lt;EPEN);<br />}<br /><br />static inline u8 ReadWriteAllowed()<br />{<br />&nbsp; &nbsp;return UEINTX &amp; (1&lt;&lt;RWAL);<br />}<br /><br />static inline u8 Stalled()<br />{<br />&nbsp; &nbsp;return UEINTX &amp; (1&lt;&lt;STALLEDI);<br />}<br /><br />static inline u8 FifoFree()<br />{<br />&nbsp; &nbsp;return UEINTX &amp; (1&lt;&lt;FIFOCON);<br />}<br /><br />static inline void ReleaseRX()<br />{<br />&nbsp; &nbsp;UEINTX = 0x6B;&nbsp; &nbsp;// FIFOCON=0 NAKINI=1 RWAL=1 NAKOUTI=0 RXSTPI=1 RXOUTI=0 STALLEDI=1 TXINI=1<br />}<br /><br />static inline void ReleaseTX()<br />{<br />&nbsp; &nbsp;UEINTX = 0x3A;&nbsp; &nbsp;// FIFOCON=0 NAKINI=0 RWAL=1 NAKOUTI=1 RXSTPI=1 RXOUTI=0 STALLEDI=1 TXINI=0<br />}<br /><br />static inline u8 FrameNumber()<br />{<br />&nbsp; &nbsp;return UDFNUML;<br />}<br /><br />//==================================================================<br />//==================================================================<br /><br />u8 USBGetConfiguration(void)<br />{<br />&nbsp; &nbsp;return _usbConfiguration;<br />}<br /><br />#define USB_RECV_TIMEOUT<br />class LockEP<br />{<br />&nbsp; &nbsp;u8 _sreg;<br />public:<br />&nbsp; &nbsp;LockEP(u8 ep) : _sreg(SREG)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;cli();<br />&nbsp; &nbsp;&nbsp; &nbsp;SetEP(ep &amp; 7);<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;~LockEP()<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;SREG = _sreg;<br />&nbsp; &nbsp;}<br />};<br /><br />//&nbsp; &nbsp;Number of bytes, assumes a rx endpoint<br />u8 USB_Available(u8 ep)<br />{<br />&nbsp; &nbsp;LockEP lock(ep);<br />&nbsp; &nbsp;return FifoByteCount();<br />}<br /><br />//&nbsp; &nbsp;Non Blocking receive<br />//&nbsp; &nbsp;Return number of bytes read<br />int USB_Recv(u8 ep, void* d, int len)<br />{<br />&nbsp; &nbsp;if (!_usbConfiguration || len &lt; 0)<br />&nbsp; &nbsp;&nbsp; &nbsp;return -1;<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;LockEP lock(ep);<br />&nbsp; &nbsp;u8 n = FifoByteCount();<br />&nbsp; &nbsp;len = min(n,len);<br />&nbsp; &nbsp;n = len;<br />&nbsp; &nbsp;u8* dst = (u8*)d;<br />&nbsp; &nbsp;while (n--)<br />&nbsp; &nbsp;&nbsp; &nbsp;*dst++ = Recv8();<br />&nbsp; &nbsp;if (len &amp;&amp; !FifoByteCount())&nbsp; &nbsp;// release empty buffer<br />&nbsp; &nbsp;&nbsp; &nbsp;ReleaseRX();<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;return len;<br />}<br /><br />//&nbsp; &nbsp;Recv 1 byte if ready<br />int USB_Recv(u8 ep)<br />{<br />&nbsp; &nbsp;u8 c;<br />&nbsp; &nbsp;if (USB_Recv(ep,&amp;c,1) != 1)<br />&nbsp; &nbsp;&nbsp; &nbsp;return -1;<br />&nbsp; &nbsp;return c;<br />}<br /><br />//&nbsp; &nbsp;Space in send EP<br />u8 USB_SendSpace(u8 ep)<br />{<br />&nbsp; &nbsp;LockEP lock(ep);<br />&nbsp; &nbsp;if (!ReadWriteAllowed())<br />&nbsp; &nbsp;&nbsp; &nbsp;return 0;<br />&nbsp; &nbsp;return 64 - FifoByteCount();<br />}<br /><br />//&nbsp; &nbsp;Blocking Send of data to an endpoint<br />int USB_Send(u8 ep, const void* d, int len)<br />{<br />&nbsp; &nbsp;if (!_usbConfiguration)<br />&nbsp; &nbsp;&nbsp; &nbsp;return -1;<br /><br />&nbsp; &nbsp;int r = len;<br />&nbsp; &nbsp;const u8* data = (const u8*)d;<br />&nbsp; &nbsp;u8 timeout = 250;&nbsp; &nbsp;&nbsp; &nbsp;// 250ms timeout on send? TODO<br />&nbsp; &nbsp;while (len)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;u8 n = USB_SendSpace(ep);<br />&nbsp; &nbsp;&nbsp; &nbsp;if (n == 0)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if (!(--timeout))<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return -1;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;delay(1);<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;continue;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;if (n &gt; len)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;n = len;<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;LockEP lock(ep);<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// Frame may have been released by the SOF interrupt handler<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if (!ReadWriteAllowed())<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;continue;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;len -= n;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if (ep &amp; TRANSFER_ZERO)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;while (n--)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Send8(0);<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;else if (ep &amp; TRANSFER_PGM)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;while (n--)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Send8(pgm_read_byte(data++));<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;else<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;while (n--)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Send8(*data++);<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if (!ReadWriteAllowed() || ((len == 0) &amp;&amp; (ep &amp; TRANSFER_RELEASE)))&nbsp; &nbsp;// Release full buffer<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ReleaseTX();<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;TXLED1;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// light the TX LED<br />&nbsp; &nbsp;TxLEDPulse = TX_RX_LED_PULSE_MS;<br />&nbsp; &nbsp;return r;<br />}<br /><br />extern const u8 _initEndpoints&#91;&#93; PROGMEM;<br />const u8 _initEndpoints&#91;&#93; = <br />{<br />&nbsp; &nbsp;0,<br />&nbsp; &nbsp;<br />#ifdef CDC_ENABLED<br />&nbsp; &nbsp;EP_TYPE_INTERRUPT_IN,&nbsp; &nbsp;&nbsp; &nbsp;// CDC_ENDPOINT_ACM<br />&nbsp; &nbsp;EP_TYPE_BULK_OUT,&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// CDC_ENDPOINT_OUT<br />&nbsp; &nbsp;EP_TYPE_BULK_IN,&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// CDC_ENDPOINT_IN<br />#endif<br /><br />#ifdef HID_ENABLED<br />&nbsp; &nbsp;EP_TYPE_INTERRUPT_IN&nbsp; &nbsp;&nbsp; &nbsp;// HID_ENDPOINT_INT<br />#endif<br />};<br /><br />#define EP_SINGLE_64 0x32&nbsp; &nbsp;// EP0<br />#define EP_DOUBLE_64 0x36&nbsp; &nbsp;// Other endpoints<br /><br />static<br />void InitEP(u8 index, u8 type, u8 size)<br />{<br />&nbsp; &nbsp;UENUM = index;<br />&nbsp; &nbsp;UECONX = 1;<br />&nbsp; &nbsp;UECFG0X = type;<br />&nbsp; &nbsp;UECFG1X = size;<br />}<br /><br />static<br />void InitEndpoints()<br />{<br />&nbsp; &nbsp;for (u8 i = 1; i &lt; sizeof(_initEndpoints); i++)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;UENUM = i;<br />&nbsp; &nbsp;&nbsp; &nbsp;UECONX = 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;UECFG0X = pgm_read_byte(_initEndpoints+i);<br />&nbsp; &nbsp;&nbsp; &nbsp;UECFG1X = EP_DOUBLE_64;<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;UERST = 0x7E;&nbsp; &nbsp;// And reset them<br />&nbsp; &nbsp;UERST = 0;<br />}<br /><br />//&nbsp; &nbsp;Handle CLASS_INTERFACE requests<br />static<br />bool ClassInterfaceRequest(Setup&amp; setup)<br />{<br />&nbsp; &nbsp;u8 i = setup.wIndex;<br /><br />#ifdef CDC_ENABLED<br />&nbsp; &nbsp;if (CDC_ACM_INTERFACE == i)<br />&nbsp; &nbsp;&nbsp; &nbsp;return CDC_Setup(setup);<br />#endif<br /><br />#ifdef HID_ENABLED<br />&nbsp; &nbsp;if (HID_INTERFACE == i)<br />&nbsp; &nbsp;&nbsp; &nbsp;return HID_Setup(setup);<br />#endif<br />&nbsp; &nbsp;return false;<br />}<br /><br />int _cmark;<br />int _cend;<br />void InitControl(int end)<br />{<br />&nbsp; &nbsp;SetEP(0);<br />&nbsp; &nbsp;_cmark = 0;<br />&nbsp; &nbsp;_cend = end;<br />}<br /><br />static<br />bool SendControl(u8 d)<br />{<br />&nbsp; &nbsp;if (_cmark &lt; _cend)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;if (!WaitForINOrOUT())<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return false;<br />&nbsp; &nbsp;&nbsp; &nbsp;Send8(d);<br />&nbsp; &nbsp;&nbsp; &nbsp;if (!((_cmark + 1) &amp; 0x3F))<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ClearIN();&nbsp; &nbsp;// Fifo is full, release this packet<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;_cmark++;<br />&nbsp; &nbsp;return true;<br />};<br /><br />//&nbsp; &nbsp;Clipped by _cmark/_cend<br />int USB_SendControl(u8 flags, const void* d, int len)<br />{<br />&nbsp; &nbsp;int sent = len;<br />&nbsp; &nbsp;const u8* data = (const u8*)d;<br />&nbsp; &nbsp;bool pgm = flags &amp; TRANSFER_PGM;<br />&nbsp; &nbsp;while (len--)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;u8 c = pgm ? pgm_read_byte(data++) : *data++;<br />&nbsp; &nbsp;&nbsp; &nbsp;if (!SendControl(c))<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return -1;<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;return sent;<br />}<br /><br />// Send a USB descriptor string. The string is stored in PROGMEM as a<br />// plain ASCII string but is sent out as UTF-16 with the correct 2-byte<br />// prefix<br />static bool USB_SendStringDescriptor(const u8*string_P, u8 string_len) {<br />&nbsp; &nbsp; &nbsp; &nbsp; SendControl(2 + string_len * 2);<br />&nbsp; &nbsp; &nbsp; &nbsp; SendControl(3);<br />&nbsp; &nbsp; &nbsp; &nbsp; for(u8 i = 0; i &lt; string_len; i++) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bool r = SendControl(pgm_read_byte(&amp;string_P&#91;i&#93;));<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r &amp;= SendControl(0); // high byte<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(!r) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; return true;<br />}<br /><br />//&nbsp; &nbsp;Does not timeout or cross fifo boundaries<br />//&nbsp; &nbsp;Will only work for transfers &lt;= 64 bytes<br />//&nbsp; &nbsp;TODO<br />int USB_RecvControl(void* d, int len)<br />{<br />&nbsp; &nbsp;WaitOUT();<br />&nbsp; &nbsp;Recv((u8*)d,len);<br />&nbsp; &nbsp;ClearOUT();<br />&nbsp; &nbsp;return len;<br />}<br /><br />int SendInterfaces()<br />{<br />&nbsp; &nbsp;int total = 0;<br />&nbsp; &nbsp;u8 interfaces = 0;<br /><br />#ifdef CDC_ENABLED<br />&nbsp; &nbsp;total = CDC_GetInterface(&amp;interfaces);<br />#endif<br /><br />#ifdef HID_ENABLED<br />&nbsp; &nbsp;total += HID_GetInterface(&amp;interfaces);<br />#endif<br /><br />&nbsp; &nbsp;return interfaces;<br />}<br /><br />//&nbsp; &nbsp;Construct a dynamic configuration descriptor<br />//&nbsp; &nbsp;This really needs dynamic endpoint allocation etc<br />//&nbsp; &nbsp;TODO<br />static<br />bool SendConfiguration(int maxlen)<br />{<br />&nbsp; &nbsp;//&nbsp; &nbsp;Count and measure interfaces<br />&nbsp; &nbsp;InitControl(0);&nbsp; &nbsp;<br />&nbsp; &nbsp;int interfaces = SendInterfaces();<br />&nbsp; &nbsp;ConfigDescriptor config = D_CONFIG(_cmark + sizeof(ConfigDescriptor),interfaces);<br /><br />&nbsp; &nbsp;//&nbsp; &nbsp;Now send them<br />&nbsp; &nbsp;InitControl(maxlen);<br />&nbsp; &nbsp;USB_SendControl(0,&amp;config,sizeof(ConfigDescriptor));<br />&nbsp; &nbsp;SendInterfaces();<br />&nbsp; &nbsp;return true;<br />}<br /><br />u8 _cdcComposite = 0;<br /><br />static<br />bool SendDescriptor(Setup&amp; setup)<br />{<br />&nbsp; &nbsp;u8 t = setup.wValueH;<br />&nbsp; &nbsp;if (USB_CONFIGURATION_DESCRIPTOR_TYPE == t)<br />&nbsp; &nbsp;&nbsp; &nbsp;return SendConfiguration(setup.wLength);<br /><br />&nbsp; &nbsp;InitControl(setup.wLength);<br />#ifdef HID_ENABLED<br />&nbsp; &nbsp;if (HID_REPORT_DESCRIPTOR_TYPE == t)<br />&nbsp; &nbsp;&nbsp; &nbsp;return HID_GetDescriptor(t);<br />#endif<br /><br />&nbsp; &nbsp;const u8* desc_addr = 0;<br />&nbsp; &nbsp;if (USB_DEVICE_DESCRIPTOR_TYPE == t)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;if (setup.wLength == 8)<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;_cdcComposite = 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;desc_addr = _cdcComposite ?&nbsp; (const u8*)&amp;USB_DeviceDescriptorA : (const u8*)&amp;USB_DeviceDescriptor;<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;else if (USB_STRING_DESCRIPTOR_TYPE == t)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;if (setup.wValueL == 0) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;desc_addr = (const u8*)&amp;STRING_LANGUAGE;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (setup.wValueL == IPRODUCT) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return USB_SendStringDescriptor(STRING_PRODUCT, strlen(USB_PRODUCT));<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (setup.wValueL == IMANUFACTURER) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return USB_SendStringDescriptor(STRING_MANUFACTURER, strlen(USB_MANUFACTURER));<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;return false;<br />&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;if (desc_addr == 0)<br />&nbsp; &nbsp;&nbsp; &nbsp;return false;<br />&nbsp; &nbsp;u8 desc_length = pgm_read_byte(desc_addr);<br /><br />&nbsp; &nbsp;USB_SendControl(TRANSFER_PGM,desc_addr,desc_length);<br />&nbsp; &nbsp;return true;<br />}<br /><br />//&nbsp; &nbsp;Endpoint 0 interrupt<br />ISR(USB_COM_vect)<br />{<br />&nbsp; &nbsp; SetEP(0);<br />&nbsp; &nbsp;if (!ReceivedSetupInt())<br />&nbsp; &nbsp;&nbsp; &nbsp;return;<br /><br />&nbsp; &nbsp;Setup setup;<br />&nbsp; &nbsp;Recv((u8*)&amp;setup,8);<br />&nbsp; &nbsp;ClearSetupInt();<br /><br />&nbsp; &nbsp;u8 requestType = setup.bmRequestType;<br />&nbsp; &nbsp;if (requestType &amp; REQUEST_DEVICETOHOST)<br />&nbsp; &nbsp;&nbsp; &nbsp;WaitIN();<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;&nbsp; &nbsp;ClearIN();<br /><br />&nbsp; &nbsp; bool ok = true;<br />&nbsp; &nbsp;if (REQUEST_STANDARD == (requestType &amp; REQUEST_TYPE))<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;//&nbsp; &nbsp;Standard Requests<br />&nbsp; &nbsp;&nbsp; &nbsp;u8 r = setup.bRequest;<br />&nbsp; &nbsp;&nbsp; &nbsp;if (GET_STATUS == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Send8(0);&nbsp; &nbsp;&nbsp; &nbsp;// TODO<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Send8(0);<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (CLEAR_FEATURE == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (SET_FEATURE == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (SET_ADDRESS == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;WaitIN();<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;UDADDR = setup.wValueL | (1&lt;&lt;ADDEN);<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (GET_DESCRIPTOR == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ok = SendDescriptor(setup);<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (SET_DESCRIPTOR == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ok = false;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (GET_CONFIGURATION == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Send8(1);<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (SET_CONFIGURATION == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if (REQUEST_DEVICE == (requestType &amp; REQUEST_RECIPIENT))<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;InitEndpoints();<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;_usbConfiguration = setup.wValueL;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;} else<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ok = false;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (GET_INTERFACE == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;else if (SET_INTERFACE == r)<br />&nbsp; &nbsp;&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;InitControl(setup.wLength);&nbsp; &nbsp;&nbsp; &nbsp;//&nbsp; &nbsp;Max length of transfer<br />&nbsp; &nbsp;&nbsp; &nbsp;ok = ClassInterfaceRequest(setup);<br />&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;if (ok)<br />&nbsp; &nbsp;&nbsp; &nbsp;ClearIN();<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;Stall();<br />&nbsp; &nbsp;}<br />}<br /><br />void USB_Flush(u8 ep)<br />{<br />&nbsp; &nbsp;SetEP(ep);<br />&nbsp; &nbsp;if (FifoByteCount())<br />&nbsp; &nbsp;&nbsp; &nbsp;ReleaseTX();<br />}<br /><br />//&nbsp; &nbsp;General interrupt<br />ISR(USB_GEN_vect)<br />{<br />&nbsp; &nbsp;u8 udint = UDINT;<br />&nbsp; &nbsp;UDINT = 0;<br /><br />&nbsp; &nbsp;//&nbsp; &nbsp;End of Reset<br />&nbsp; &nbsp;if (udint &amp; (1&lt;&lt;EORSTI))<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp;&nbsp; &nbsp;InitEP(0,EP_TYPE_CONTROL,EP_SINGLE_64);&nbsp; &nbsp;// init ep0<br />&nbsp; &nbsp;&nbsp; &nbsp;_usbConfiguration = 0;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// not configured yet<br />&nbsp; &nbsp;&nbsp; &nbsp;UEIENX = 1 &lt;&lt; RXSTPE;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// Enable interrupts for ep0<br />&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;//&nbsp; &nbsp;Start of Frame - happens every millisecond so we use it for TX and RX LED one-shot timing, too<br />&nbsp; &nbsp;if (udint &amp; (1&lt;&lt;SOFI))<br />&nbsp; &nbsp;{<br />#ifdef CDC_ENABLED<br />&nbsp; &nbsp;&nbsp; &nbsp;USB_Flush(CDC_TX);&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// Send a tx frame if found<br />#endif<br />&nbsp; &nbsp;&nbsp; &nbsp;<br />&nbsp; &nbsp;&nbsp; &nbsp;// check whether the one-shot period has elapsed.&nbsp; if so, turn off the LED<br />&nbsp; &nbsp;&nbsp; &nbsp;if (TxLEDPulse &amp;&amp; !(--TxLEDPulse))<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;TXLED0;<br />&nbsp; &nbsp;&nbsp; &nbsp;if (RxLEDPulse &amp;&amp; !(--RxLEDPulse))<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;RXLED0;<br />&nbsp; &nbsp;}<br />}<br /><br />//&nbsp; &nbsp;VBUS or counting frames<br />//&nbsp; &nbsp;Any frame counting?<br />u8 USBConnected()<br />{<br />&nbsp; &nbsp;u8 f = UDFNUML;<br />&nbsp; &nbsp;delay(3);<br />&nbsp; &nbsp;return f != UDFNUML;<br />}<br /><br />//=======================================================================<br />//=======================================================================<br /><br />USBDevice_ USBDevice;<br /><br />USBDevice_::USBDevice_()<br />{<br />}<br /><br />void USBDevice_::attach()<br />{<br />&nbsp; &nbsp;_usbConfiguration = 0;<br />&nbsp; &nbsp;UHWCON = 0x01;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// power internal reg<br />&nbsp; &nbsp;USBCON = (1&lt;&lt;USBE)|(1&lt;&lt;FRZCLK);&nbsp; &nbsp;&nbsp; &nbsp;// clock frozen, usb enabled<br />#if F_CPU == 16000000UL<br />&nbsp; &nbsp;PLLCSR = 0x12;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// Need 16 MHz xtal<br />#elif F_CPU == 8000000UL<br />&nbsp; &nbsp;PLLCSR = 0x02;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// Need 8 MHz xtal<br />#endif<br />&nbsp; &nbsp;while (!(PLLCSR &amp; (1&lt;&lt;PLOCK)))&nbsp; &nbsp;&nbsp; &nbsp;// wait for lock pll<br />&nbsp; &nbsp;&nbsp; &nbsp;;<br /><br />&nbsp; &nbsp;// Some tests on specific versions of macosx (10.7.3), reported some<br />&nbsp; &nbsp;// strange behaviuors when the board is reset using the serial<br />&nbsp; &nbsp;// port touch at 1200 bps. This delay fixes this behaviour.<br />&nbsp; &nbsp;delay(1);<br /><br />&nbsp; &nbsp;USBCON = ((1&lt;&lt;USBE)|(1&lt;&lt;OTGPADE));&nbsp; &nbsp;// start USB clock<br />&nbsp; &nbsp;UDIEN = (1&lt;&lt;EORSTE)|(1&lt;&lt;SOFE);&nbsp; &nbsp;&nbsp; &nbsp;// Enable interrupts for EOR (End of Reset) and SOF (start of frame)<br />&nbsp; &nbsp;UDCON = 0;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// enable attach resistor<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;TX_RX_LED_INIT;<br />}<br /><br />void USBDevice_::detach()<br />{<br />}<br /><br />//&nbsp; &nbsp;Check for interrupts<br />//&nbsp; &nbsp;TODO: VBUS detection<br />bool USBDevice_::configured()<br />{<br />&nbsp; &nbsp;return _usbConfiguration;<br />}<br /><br />void USBDevice_::poll()<br />{<br />}<br /><br />#endif /* if defined(USBCON) */<br /></code></dd></dl></div>

			

		</div>

		
			<dl class="postprofile" id="profile369">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 14</dd><dd><strong>Joined:</strong> Thu Apr 09, 2015 12:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p370" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=370&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p370">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=370&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p370"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=82&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">jeruw</a></strong> &raquo; Sun Apr 12, 2015 4:48 pm </p>

			

			<div class="content">Would you be willing/able to re-apply these code changes in a fork of the project on GitHub? That will make it a lot easier to review changes and for zdayton or others to pull bits into their own repositories.<br /><br />Great work, by the way!</div>

			

		</div>

		
			<dl class="postprofile" id="profile370">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=82&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">jeruw</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 80</dd><dd><strong>Joined:</strong> Tue Feb 17, 2015 3:10 pm</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p373" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=373&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p373">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=373&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p373"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a></strong> &raquo; Sun Apr 12, 2015 11:02 pm </p>

			

			<div class="content">Never worked with Git Hub, so I have no idea how to even go about doing that.  I am a software developer by trade, so I'm familiar with source repos, just gonna take a bit to figure out.</div>

			

		</div>

		
			<dl class="postprofile" id="profile373">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 14</dd><dd><strong>Joined:</strong> Thu Apr 09, 2015 12:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p550" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=550&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p550">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=550&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p550"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=87&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">SC-Maik</a></strong> &raquo; Thu May 28, 2015 8:21 am </p>

			

			<div class="content">How can we program throttle to register as a 10bit resolution joystick (0-1023 per axis) and not 8bit (0-255)?<br /><br />Since we are moving towards hall effect sensors, shouldn't we also use full potential of both Pro Micro ADC and sensors' greater resolution?</div>

			

		</div>

		
			<dl class="postprofile" id="profile550">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=87&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">SC-Maik</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 142</dd><dd><strong>Joined:</strong> Tue Mar 03, 2015 3:20 pm</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p569" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=569&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p569">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=569&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p569"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=105&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">mike43110</a></strong> &raquo; Wed Jun 03, 2015 1:17 pm </p>

			

			<div class="content"><blockquote><div><cite>SC-Maik wrote:</cite>How can we program throttle to register as a 10bit resolution joystick (0-1023 per axis) and not 8bit (0-255)?<br /><br />Since we are moving towards hall effect sensors, shouldn't we also use full potential of both Pro Micro ADC and sensors' greater resolution?</div></blockquote><br /><br />I would like that as well!<br /><br />But I am not to sure on how to do it... I am looking it up. A pull request would be great for this kind of thing as then everyone's work can be integrated.</div>

			

		</div>

		
			<dl class="postprofile" id="profile569">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=105&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">mike43110</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 21</dd><dd><strong>Joined:</strong> Fri Apr 24, 2015 11:45 pm</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p577" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=577&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p577">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=577&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p577"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a></strong> &raquo; Wed Jun 10, 2015 2:03 pm </p>

			

			<div class="content">I'm not sure that you can exactly.  The reason is the limitations on the HID descriptor.  All of the examples limit the range to 1 byte(0-255 or -127-127), but I've not seen anything that says you can't do more.  At the same time I'd make sure my values stuck to byte boundaries, otherwise you'll have to deal with spacer bits.  Which is why I have 16 buttons in my HID descriptor while only using 4.  So don't do 10-bit, go to 16-bit or +/- 32K.<br /><br />What you'll need to do is get an HID descriptor writing program, then once you've built your descriptor with the larger values &amp; replace my HID descriptor in the HID.cpp file.  Next, you'll want to make the necessary changes to the Joystick_ object defined in that same file.  I have all my axes in an array of unsigned 8-bit integers &amp; then memcpy that to the byte array sent through the USB methods.  Since I have more than the 3 axes for the throttle, you'll probably want to break that up &amp; store the non-throttle axes in 1 array &amp; the throttle axes in another, unless you plan on reporting all axes with the larger range.  If you use 2 different axes arrays, you'll need to add a new memcpy line, and in either case you'll have to adjust the copy length to match your new array(s).  Whatever you do, make sure that your byte array matches the HID Descriptor in length &amp; bit placement.</div>

			

		</div>

		
			<dl class="postprofile" id="profile577">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 14</dd><dd><strong>Joined:</strong> Thu Apr 09, 2015 12:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p578" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=578&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p578">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=578&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p578"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=105&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">mike43110</a></strong> &raquo; Wed Jun 10, 2015 4:21 pm </p>

			

			<div class="content"><blockquote><div><cite>Nemesisghost wrote:</cite>I'm not sure that you can exactly.  The reason is the limitations on the HID descriptor.  All of the examples limit the range to 1 byte(0-255 or -127-127), but I've not seen anything that says you can't do more.  At the same time I'd make sure my values stuck to byte boundaries, otherwise you'll have to deal with spacer bits.  Which is why I have 16 buttons in my HID descriptor while only using 4.  So don't do 10-bit, go to 16-bit or +/- 32K.<br /><br />What you'll need to do is get an HID descriptor writing program, then once you've built your descriptor with the larger values &amp; replace my HID descriptor in the HID.cpp file.  Next, you'll want to make the necessary changes to the Joystick_ object defined in that same file.  I have all my axes in an array of unsigned 8-bit integers &amp; then memcpy that to the byte array sent through the USB methods.  Since I have more than the 3 axes for the throttle, you'll probably want to break that up &amp; store the non-throttle axes in 1 array &amp; the throttle axes in another, unless you plan on reporting all axes with the larger range.  If you use 2 different axes arrays, you'll need to add a new memcpy line, and in either case you'll have to adjust the copy length to match your new array(s).  Whatever you do, make sure that your byte array matches the HID Descriptor in length &amp; bit placement.</div></blockquote><br /><br />Quite interesting! I haven't dealt with USB before so this will be something - a future problem as I have other things that need to be done (booo - at least SC is taking forever! (game not person)). Will the descriptor also deal with the multiple reports that have to be sent? i.e. each 64-bit block.<br /><br />I know multiple reports can be sent to deal with larger sizes so you have to store the number of reports when describing the descriptor. I though have NO idea how to do that exactly. Once my work is done and my personal designs are as well then I will only deal with the software.</div>

			

		</div>

		
			<dl class="postprofile" id="profile578">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=105&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">mike43110</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 21</dd><dd><strong>Joined:</strong> Fri Apr 24, 2015 11:45 pm</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<div id="p579" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			
				<ul class="profile-icons">
					<li class="quote-icon"><a href="posting.php@mode=quote&amp;f=8&amp;p=579&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Reply with quote"><span>Reply with quote</span></a></li>
				</ul>
			

			<h3 ><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p579">Re: Compiler Issues</a></h3>
			<p class="author"><a href="viewtopic.php@p=579&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#p579"><img src="styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" /></a>by <strong><a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a></strong> &raquo; Thu Jun 11, 2015 11:50 am </p>

			

			<div class="content">You define the reports in the HID Descriptor.  I know there are some limitations on how large each report can be, which is one of the reasons I didn't group the axes(something that's not entirely necessary, but is ascetically pleasing in the joystick properties screen).  I didn't do multiple reports just because 1 was enough to do what I needed.  But it was something I was looking into so I could group my axes.<br /><br />Here's a <a href="http://eleccelerator.com/tutorial-about-usb-hid-report-descriptors/" class="postlink">good tutorial</a> on how to build HID descriptors &amp; how to align the bits to match.  It has a link to the official USB HID documentation, which itself has an HID writing app.  That app is what I used to build mine.</div>

			

		</div>

		
			<dl class="postprofile" id="profile579">
			<dt>
				<a href="memberlist.php@mode=viewprofile&amp;u=102&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Nemesisghost</a>
			</dt>

			

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 14</dd><dd><strong>Joined:</strong> Thu Apr 09, 2015 12:44 am</dd>

		</dl>
	

		<div class="back2top"><a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<form id="viewtopic" method="post" action="viewtopic.php@f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">

	<fieldset class="display-options" style="margin-top: 0; ">
		<a href="viewtopic.php@f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e&amp;start=10.html" class="right-box right">Next</a>
		<label>Display posts from previous: <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select></label>
		<label>Sort by <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select></label> <label><select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select> <input type="submit" name="sort" value="Go" class="button2" /></label>
		
	</fieldset>

	</form>
	<hr />


<div class="topic-actions">
	<div class="buttons">
	
		<div class="reply-icon"><a href="posting.php@mode=reply&amp;f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" title="Post a reply"><span></span>Post a reply</a></div>
	
	</div>

	
		<div class="pagination">
			15 posts
			 &bull; <a href="viewtopic.php@p=368&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html#" onclick="jumpto(); return false;" title="Click to jump to page…">Page <strong>1</strong> of <strong>2</strong></a> &bull; <span><strong>1</strong><span class="page-sep">, </span><a href="viewtopic.php@f=8&amp;t=118&amp;sid=2da7d3261aa1b35db93cfc0fa069564e&amp;start=10.html">2</a></span>
		</div>
	
</div>


	<p></p><p><a href="viewforum.php@f=8&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html" class="left-box left" accesskey="r">Return to Build progress and showcase</a></p>

	<form method="post" id="jumpbox" action="http://173.236.165.188/forums/viewforum.php?sid=2da7d3261aa1b35db93cfc0fa069564e" onsubmit="if(this.f.value == -1){return false;}">

	
		<fieldset class="jumpbox">
	
			<label for="f" accesskey="j">Jump to:</label>
			<select name="f" id="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">
			
				<option value="-1">Select a forum</option>
			<option value="-1">------------------</option>
				<option value="1">Delta Throttle</option>
			
				<option value="4">&nbsp; &nbsp;Discussion</option>
			
				<option value="5">&nbsp; &nbsp;Feedback</option>
			
				<option value="8" selected="selected">&nbsp; &nbsp;Build progress and showcase</option>
			
				<option value="3">Games</option>
			
				<option value="6">&nbsp; &nbsp;Star Citizen</option>
			
				<option value="7">&nbsp; &nbsp;Elite:Dangerous</option>
			
			</select>
			<input type="submit" value="Go" class="button2" />
		</fieldset>
	</form>


	<h3>Who is online</h3>
	<p>Users browsing this forum: No registered users and 0 guests</p>
</div>

<div id="page-footer">

	<div class="navbar">
		<div class="inner"><span class="corners-top"><span></span></span>

		<ul class="linklist">
			<li class="icon-home"><a href="index.php@sid=2da7d3261aa1b35db93cfc0fa069564e.html" accesskey="h">Board index</a></li>
				
			<li class="rightside"><a href="memberlist.php@mode=leaders&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">The team</a> &bull; <a href="ucp.php@mode=delete_cookies&amp;sid=2da7d3261aa1b35db93cfc0fa069564e.html">Delete all board cookies</a> &bull; All times are UTC </li>
		</ul>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<div class="copyright">Powered by <a href="https://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
		
	</div>
</div>

</div>

<div>
	<a id="bottom" name="bottom" accesskey="z"></a>
	<img src="cron.php@cron_type=tidy_search&amp;sid=2da7d3261aa1b35db93cfc0fa069564e" width="1" height="1" alt="cron" />
</div>

</body>
</html>